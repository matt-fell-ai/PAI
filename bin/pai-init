#!/usr/bin/env python3
import os
import sys
import subprocess
import getpass

PAI_ROOT = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))

def print_banner():
    print("""
    =========================================
       WELCOME TO YOUR PERSONAL AI INFRA
    =========================================
    I am your PAI Digital Assistant. Let's get
    your infrastructure set up for 2026.
    """)

def get_input(prompt, default=None):
    if default:
        res = input(f"{prompt} [{default}]: ").strip()
        return res if res else default
    return input(f"{prompt}: ").strip()

def setup_identity():
    print("\n--- Phase 1: Identity ---")
    user_name = get_input("What is your name?")
    da_name = get_input("What should my name be?", "PAI")
    
    # Update settings.json if it exists
    settings_path = os.path.join(PAI_ROOT, ".claude", "settings.json")
    if os.path.exists(settings_path):
        import json
        try:
            with open(settings_path, 'r') as f:
                data = json.load(f)
            if "env" not in data: data["env"] = {}
            data["env"]["DA"] = da_name
            with open(settings_path, 'w') as f:
                json.dump(data, f, indent=2)
            print(f"Updating identity to '{da_name}' in settings.json...")
        except Exception as e:
            print(f"Warning: Could not update settings.json: {e}")
    
    # Update CORE/SKILL.md as well
    core_skill_path = os.path.join(PAI_ROOT, "skills", "CORE", "SKILL.md")
    if os.path.exists(core_skill_path):
        try:
            with open(core_skill_path, 'r') as f:
                content = f.read()
            # Simple replacement
            if "- Name: PAI" in content:
                content = content.replace("- Name: PAI", f"- Name: {da_name}")
                with open(core_skill_path, 'w') as f:
                    f.write(content)
        except:
            pass

    print(f"Identity confirmed. Welcome, {user_name}. I am {da_name}.")
    return user_name, da_name

def validate_key(key, provider):
    if not key:
        return True
    if provider == "Anthropic" and not key.startswith("sk-ant-"):
        print(f" [!] Warning: {provider} key usually starts with 'sk-ant-'.")
    elif provider == "OpenAI" and not key.startswith("sk-"):
        print(f" [!] Warning: {provider} key usually starts with 'sk-'.")
    elif provider == "Google Gemini" and len(key) < 30:
        print(f" [!] Warning: {provider} key seems too short.")
    return True

def setup_vault():
    print("\n--- Phase 2: The Vault (Secrets) ---")
    print("Paste your API keys below. They will be stored in your local .env file.")
    
    anthropic = getpass.getpass("Anthropic API Key (Enter to skip): ").strip()
    validate_key(anthropic, "Anthropic")
    
    openai = getpass.getpass("OpenAI API Key (Enter to skip): ").strip()
    validate_key(openai, "OpenAI")

    gemini = getpass.getpass("Google Gemini API Key (Enter to skip): ").strip()
    validate_key(gemini, "Google Gemini")

    print("\n--- Phase 2.5: Local Models (Ollama) ---")
    ollama_url = get_input("Ollama Host URL", "http://localhost:11434")
    ollama_model = get_input("Ollama Default Model", "llama3")
    
    env_path = os.path.join(PAI_ROOT, ".env")
    
    # Read existing keys to avoid duplicates
    existing_keys = {}
    if os.path.exists(env_path):
        with open(env_path, "r") as f:
            for line in f:
                if "=" in line:
                    k, v = line.split("=", 1)
                    existing_keys[k.strip()] = v.strip()

    with open(env_path, "a") as f:
        if anthropic and "ANTHROPIC_API_KEY" not in existing_keys:
            f.write(f"ANTHROPIC_API_KEY={anthropic}\n")
        if openai and "OPENAI_API_KEY" not in existing_keys:
            f.write(f"OPENAI_API_KEY={openai}\n")
        if gemini and "GOOGLE_API_KEY" not in existing_keys:
            f.write(f"GOOGLE_API_KEY={gemini}\n")
        if "OLLAMA_HOST" not in existing_keys:
            f.write(f"OLLAMA_HOST={ollama_url}\n")
        if "OLLAMA_MODEL" not in existing_keys:
            f.write(f"OLLAMA_MODEL={ollama_model}\n")
    
    print("Secrets and Local Config secured in .env.")

def setup_bridge():
    print("\n--- Phase 3: Universal Bridge ---")
    print("Generating PAI_INSTRUCTIONS.md for your AI agents...")
    
    # Call the original instruction generator logic
    # (Reusing logic from the previous pai-init but refined)
    content = f"""# Universal PAI Agent Instructions
PATH: {PAI_ROOT}
Talk to me via: {PAI_ROOT}/bin/pai run <Skill> <cmd>
"""
    with open(os.path.join(PAI_ROOT, "PAI_INSTRUCTIONS.md"), 'w') as f:
        f.write(content)
    print("Bridge instructions generated.")

def setup_shell():
    print("\n--- Phase 4: Shell Integration ---")
    shell_profile = None
    home = os.path.expanduser("~")
    
    if os.path.exists(os.path.join(home, ".zshrc")):
        shell_profile = os.path.join(home, ".zshrc")
    elif os.path.exists(os.path.join(home, ".bashrc")):
        shell_profile = os.path.join(home, ".bashrc")
        
    if shell_profile:
        add_alias = get_input(f"Should I add the 'pai' alias to your {os.path.basename(shell_profile)}?", "Y").lower()
        if add_alias == 'y':
            alias_line = f"\nalias pai='{PAI_ROOT}/bin/pai'\n"
            with open(shell_profile, "a") as f:
                f.write(alias_line)
            print(f"Alias added. Please run 'source {shell_profile}' to activate it.")
        else:
            print("Skipping shell integration.")
    else:
        print("Could not find .bashrc or .zshrc. Please add the following to your profile manually:")
        print(f"alias pai='{PAI_ROOT}/bin/pai'")

def main():
    print_banner()
    user_name, da_name = setup_identity()
    setup_vault()
    setup_bridge()
    setup_shell()
    
    print("\n--- Setup Complete ---")
    print(f"You're all set! Run 'pai list' (after sourcing your profile) to see your new skills.")
    print("TIP: Try 'pai run Manual help' for a guided walkthrough.")

if __name__ == "__main__":
    main()
