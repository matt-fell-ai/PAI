#!/usr/bin/env python3
import os
import sys
import subprocess
import getpass
import json

PAI_ROOT = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
sys.path.append(os.path.join(PAI_ROOT, "bin", "lib"))

try:
    from ui import PAI_UI, console
except ImportError:
    class PAI_UI:
        @staticmethod
        def print_logo(): print("PAI 2030")
        @staticmethod
        def tip(m): print(f"Tip: {m}")
        @staticmethod
        def panel(c, t, s): print(f"--- {t} ---\n{c}")

def get_input(prompt, default=None):
    if default:
        res = input(f" {prompt} [{default}]: ").strip()
        return res if res else default
    return input(f" {prompt}: ").strip()

def setup_identity():
    PAI_UI.panel("Starting Phase 1: Sovereign Identity Setup", title="Phase 1", style="cyan")
    user_name = get_input("What is your legal name (for DAO registration)?")
    da_name = get_input("What is your PAI's public designation?", "PAI-Alpha")
    
    print(f"\n[bold green]Welcome, {user_name}. Initializing {da_name} node...[/bold green]")
    return user_name, da_name

def setup_vault():
    PAI_UI.panel("Securing the Sovereign Vault (.env)", title="Phase 2: The Vault", style="yellow")
    env_path = os.path.join(PAI_ROOT, ".env")
    
    # Check for llama-cpp-python
    try:
        import llama_cpp
        has_llama = "[green]FOUND[/green]"
    except:
        has_llama = "[red]NOT FOUND[/red]"

    print(f" Local Intelligence Engine (llama-cpp-python): {has_llama}")
    
    # Collect Keys
    anthropic = getpass.getpass(" Anthropic API Key (Enter to skip): ").strip()
    openai = getpass.getpass(" OpenAI API Key (Enter to skip): ").strip()
    gemini = getpass.getpass(" Google Gemini API Key (Enter to skip): ").strip()
    
    with open(env_path, "w") as f:
        f.write(f"# PAI 2030 Configuration\n")
        if anthropic: f.write(f"ANTHROPIC_API_KEY={anthropic}\n")
        if openai: f.write(f"OPENAI_API_KEY={openai}\n")
        if gemini: f.write(f"GOOGLE_API_KEY={gemini}\n")
        f.write(f"OLLAMA_HOST=http://localhost:11434\n")
        f.write(f"OLAS_L2_RPC=https://rpc.gnosischain.com\n")
    
    PAI_UI.tip("Secrets and L2 RPC secured in .env.")

def setup_mesh():
    PAI_UI.panel("Configuring Sovereign Mesh 2.0 (Identity NFT)", title="Phase 3: The Mesh", style="magenta")
    print("This will prepare your node for on-chain registration via Olas.")
    setup_oc = get_input("Should I initialize the Mesh Protocol?", "Y").lower()
    if setup_oc == 'y':
        # Trigger Protocol generate
        subprocess.run([sys.executable, os.path.join(PAI_ROOT, "bin", "pai"), "run", "Protocol", "generate"])
        print("\n[bold white]VAI Generated. Run 'pai run Protocol register' after setup to mint your NFT.[/bold white]")

def main():
    PAI_UI.print_logo()
    console.print("[bold purple]Initializing Personal AI Infrastructure (PAI) 2030...[/bold purple]\n")
    user_name, da_name = setup_identity()
    setup_vault()
    setup_mesh()
    
    PAI_UI.panel(f"PAI 2030 is now operational. Your node is active.\nWelcome to the Sovereign Network, {user_name}.", title="Initialization Complete", style="bold green")
    print("\n Run 'pai list' to see your 70+ capabilities.")

if __name__ == "__main__":
    main()
