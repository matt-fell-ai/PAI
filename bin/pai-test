#!/usr/bin/env python3
import os
import sys
import subprocess

PAI_ROOT = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
PAI_BIN = os.path.join(PAI_ROOT, "bin", "pai")

def run_test(name, command):
    print(f"Testing {name}...", end=" ", flush=True)
    try:
        result = subprocess.run(command, capture_output=True, text=True, check=True)
        print("✅ PASS")
        return True
    except subprocess.CalledProcessError as e:
        print("❌ FAIL")
        print(f"  Command: {' '.join(command)}")
        print(f"  Error: {e.stderr or e.stdout}")
        return False

def main():
    print("=== PAI Universal Skill Test Suite ===\n")
    
    tests = [
        ("CLI Bridge (list)", [PAI_BIN, "list"]),
        ("CLI Bridge (info)", [PAI_BIN, "info", "Memory"]),
        ("API Key Check", [os.path.join(PAI_ROOT, "bin", "pai-check")]),
        ("Memory (store)", [PAI_BIN, "run", "Memory", "store", "Testing PAI 1.0"]),
        ("Memory (search)", [PAI_BIN, "run", "Memory", "search", "Testing"]),
        ("Guardian (check)", [PAI_BIN, "run", "Guardian", "check"]),
        ("Forensics (debug)", [PAI_BIN, "run", "Forensics", "debug"]),
        ("Visionary (sketch)", [PAI_BIN, "run", "Visionary", "sketch", "Test Arch"]),
        ("Synthesis (daily)", [PAI_BIN, "run", "Synthesis", "daily"]),
        ("Connector (check)", [PAI_BIN, "run", "Connector", "check"]),
        ("SelfRefine (audit)", [PAI_BIN, "run", "SelfRefine", "audit"]),
        ("Discovery (scan)", [PAI_BIN, "run", "Discovery", "scan"]),
        ("Swarm (parallel)", [PAI_BIN, "run", "Swarm", "parallel", "--task", "Test Task", "--agents", "Agent1,Agent2"]),
        ("Librarian (search)", [PAI_BIN, "run", "Librarian", "search", "PAI"]),
        ("Sideload (skill)", [PAI_BIN, "run", "Sideload", "skill", "Memory"]),
        ("Ego (analyze)", [PAI_BIN, "run", "Ego", "analyze"]),
        ("Oracle (suggest)", [PAI_BIN, "run", "Oracle", "suggest"]),
        ("Nexus (focus)", [PAI_BIN, "run", "Nexus", "focus"]),
        ("Alpha (leads)", [PAI_BIN, "run", "Alpha", "leads", "AI"]),
        ("Forge (magnet)", [PAI_BIN, "run", "Forge", "magnet", "AI PDF"]),
        ("Closer (pitch)", [PAI_BIN, "run", "Closer", "pitch", "--lead", "John", "--product", "Bot"]),
        ("Vibe (generate)", [PAI_BIN, "run", "Vibe", "generate", "Test Vibe"]),
        ("Sovereign (audit)", [PAI_BIN, "run", "Sovereign", "audit"]),
        ("Evolve (create)", [PAI_BIN, "run", "Evolve", "create", "NewSkill"]),
        ("Refactor (apply)", [PAI_BIN, "run", "Refactor", "apply"]),
        ("UFC (scaffold)", [PAI_BIN, "run", "UFC", "scaffold", "Test Project"]),
        ("Proxy (represent)", [PAI_BIN, "run", "Proxy", "represent", "--topic", "AI"]),
        ("Augment (api)", [PAI_BIN, "run", "Augment", "api", "--url", "http://test.com"]),
        ("Neural (search)", [PAI_BIN, "run", "Neural", "search", "state"]),
        ("Engine (validate)", [PAI_BIN, "run", "Engine", "validate", "bin/pai"]),
        ("Sanctum (run)", [PAI_BIN, "run", "Sanctum", "run", "bin/pai"]),
        ("Blueprint (launch)", [PAI_BIN, "run", "Blueprint", "launch", "Test Business"]),
        ("Manual (how-to)", [PAI_BIN, "run", "Manual", "how-to", "Revenue"]),
        ("Pulse (web)", [PAI_BIN, "run", "Pulse", "web"]),
        ("Iris (debug)", [PAI_BIN, "run", "Iris", "debug", "test.png"]),
        ("Echo (ingest)", [PAI_BIN, "run", "Echo", "ingest", "test.mp3"]),
        ("Spatial (blueprint)", [PAI_BIN, "run", "Spatial", "blueprint", "test.jpg"]),
        ("Sentinel (status)", [PAI_BIN, "run", "Sentinel"]),
        ("Legacy (audit)", [PAI_BIN, "run", "Legacy", "audit", "Alpha"]),
        ("Arbiter (verify)", [PAI_BIN, "run", "Arbiter", "verify", "test.com"]),
        ("Biosync (optimize)", [PAI_BIN, "run", "Biosync"]),
        ("Citadel (secure)", [PAI_BIN, "run", "Citadel"]),
        ("Ghost (recon)", [PAI_BIN, "run", "Ghost", "recon", "test.com"]),
        ("Specter (audit)", [PAI_BIN, "run", "Specter", "audit", "localhost"]),
        ("Bastion (harden)", [PAI_BIN, "run", "Bastion", "harden", "linux"]),
        ("Armory (list)", [PAI_BIN, "run", "Armory", "list"]),
        ("Protocol (generate)", [PAI_BIN, "run", "Protocol", "generate"]),
        ("Market (list)", [PAI_BIN, "run", "Market", "list"]),
        ("Sanctity (cleanse)", [PAI_BIN, "run", "Sanctity", "cleanse", "test.md"]),
        ("Lighthouse (beacon)", [PAI_BIN, "run", "Lighthouse", "beacon", "expert"]),
        ("Wallet (balance)", [PAI_BIN, "run", "Wallet", "balance"]),
        ("Nodes (bench)", [PAI_BIN, "run", "Nodes", "bench"]),
        ("Protocol (generate)", [PAI_BIN, "run", "Protocol", "generate"]),
        ("Market (manifest)", [PAI_BIN, "run", "Market", "manifest"]),
        ("Hive (orchestrate)", [PAI_BIN, "run", "Hive", "orchestrate", "Test task"]),
        ("Regen (refine)", [PAI_BIN, "run", "Regen", "refine", "Memory", "store"]),
        ("Actuate (status)", [PAI_BIN, "run", "Actuate", "status", "temp"]),
        ("Counsel (audit)", [PAI_BIN, "run", "Counsel", "audit", "test.pdf"]),
        ("Fabricate (blueprint)", [PAI_BIN, "run", "Fabricate", "blueprint", "test"]),
        ("Empathy (sync)", [PAI_BIN, "run", "Empathy", "sync"]),
        ("Immune (garden)", [PAI_BIN, "run", "Immune", "garden"]),
        ("Graph (map)", [PAI_BIN, "run", "Graph", "map", "Test Node"]),
        ("Story (register)", [PAI_BIN, "run", "Story", "register", "README.md"]),
        ("Bargain (negotiate)", [PAI_BIN, "run", "Bargain", "negotiate", "100", "50"]),
        ("Fold (compress)", [PAI_BIN, "run", "Fold", "compress", "History/memory.json"]),
        ("Ego (set)", [PAI_BIN, "run", "Ego", "set", "Be direct"]),
    ]

    passed = 0
    for name, cmd in tests:
        if run_test(name, cmd):
            passed += 1

    print(f"\nResults: {passed}/{len(tests)} tests passed.")
    
    if passed < len(tests):
        sys.exit(1)
    else:
        print("All core PAI systems are operational.")

if __name__ == "__main__":
    main()
