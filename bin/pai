#!/usr/bin/env python3
import os
import sys
import subprocess
import json

# Add lib to path
PAI_ROOT = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
sys.path.append(os.path.join(PAI_ROOT, "bin", "lib"))

from ui import PAI_UI, console
from rich.markdown import Markdown

SKILLS_DIR = os.path.join(PAI_ROOT, "skills")

def load_descriptions_from_agents_md():
    descs = {}
    agents_md_path = os.path.join(SKILLS_DIR, "agents.md")
    if os.path.exists(agents_md_path):
        with open(agents_md_path, 'r') as f:
            lines = f.readlines()
            for line in lines:
                if line.startswith("| **"):
                    parts = line.split("|")
                    if len(parts) > 2:
                        name = parts[1].replace("**", "").strip()
                        desc = parts[2].strip()
                        descs[name] = desc
    return descs

def get_skill_description(name, path, agent_descs):
    # Try agents.md first
    if name in agent_descs:
        return agent_descs[name]
    
    # Try SKILL.md frontmatter
    skill_md = os.path.join(path, "SKILL.md")
    if os.path.exists(skill_md):
        with open(skill_md, 'r', errors='ignore') as f:
            lines = f.readlines()
            for line in lines:
                if line.startswith("description:"):
                    desc = line.replace("description:", "").strip()
                    if "USE WHEN" in desc:
                        desc = desc.split("USE WHEN")[0].strip()
                    if desc and desc != "---":
                        return desc
    return "-"

def list_skills():
    categories = {
        "Core": ["CORE", "Memory", "Librarian", "Neural", "Manual", "Discovery", "UFC", "Immune", "Regen"],
        "Revenue": ["Alpha", "Forge", "Closer", "Blueprint", "Wallet"],
        "Cyber": ["Ghost", "Specter", "Bastion", "Armory", "Guardian", "Forensics", "Sanctum", "Counsel"],
        "Economy": ["Protocol", "Market", "Sanctity", "Lighthouse", "Story"],
        "Senses": ["Iris", "Echo", "Spatial", "Visionary", "Voice", "Art"],
        "Autonomy": ["Swarm", "Oracle", "Shadow", "Coop", "Evolve", "Genesis", "Refactor", "Ego", "Empathy", "Hive"],
        "Sovereign": ["Sovereign", "Biosync", "Citadel", "Vault", "Sentinel", "Pulse", "Vibe", "Observability"],
        "Strategy": ["Graph", "Fold", "Bargain"],
        "Physical": ["Actuate", "Fabricate"]
    }
    
    all_skills = sorted([d for d in os.listdir(SKILLS_DIR) if os.path.isdir(os.path.join(SKILLS_DIR, d))])
    agent_descs = load_descriptions_from_agents_md()
    
    rows = []
    for cat, members in categories.items():
        for skill in members:
            if skill in all_skills:
                desc = get_skill_description(skill, os.path.join(SKILLS_DIR, skill), agent_descs)
                rows.append([f"[bold cyan]{cat}[/bold cyan]", f"[bold yellow]{skill}[/bold yellow]", desc])
                all_skills.remove(skill)
    
    # Add leftovers
    for skill in all_skills:
        desc = get_skill_description(skill, os.path.join(SKILLS_DIR, skill), agent_descs)
        rows.append(["[dim]Misc[/dim]", f"[bold yellow]{skill}[/bold yellow]", desc])

    PAI_UI.table("PAI Universal Skill Manifest", ["Category", "Skill", "Strategic Purpose"], rows, style="blue")

def get_skill_path(skill_name):
    for item in os.listdir(SKILLS_DIR):
        if item.lower() == skill_name.lower() and os.path.isdir(os.path.join(SKILLS_DIR, item)):
            return os.path.join(SKILLS_DIR, item)
    return None

def show_help():
    PAI_UI.print_logo()
    
    help_text = """
[bold yellow]USAGE:[/bold yellow]
  pai <skill> <command> [args]
  pai <command> [args]

[bold yellow]COMMANDS:[/bold yellow]
  [green]list[/green]              List all available skills (Categorized)
  [green]info <skill>[/green]      Show detailed information for a skill
  [green]run <skill> <cmd>[/green]  Run a specific skill command
  [green]check[/green]             Run a health check on your environment
  [green]init[/green]              Launch the onboarding wizard

[bold yellow]EXAMPLES:[/bold yellow]
  pai run Memory search 'Gemini 3.0'
  pai check
  pai Ego status
"""
    console.print(help_text)
    list_skills()

def show_skill_info(skill_name, skill_path):
    skill_md_path = os.path.join(skill_path, "SKILL.md")
    if os.path.exists(skill_md_path):
        with open(skill_md_path, 'r', errors='ignore') as f:
            PAI_UI.panel(Markdown(f.read()), title=f"Skill: {skill_name}", style="cyan")
    else:
        PAI_UI.error(f"No SKILL.md found for {skill_name}")

def run_skill(skill_name, args):
    skill_path = get_skill_path(skill_name)
    if not skill_path:
        PAI_UI.error(f"Skill '{skill_name}' not found.")
        sys.exit(1)
    
    if args:
        command = args[0]
        cmd_args = args[1:]
        
        is_help = any(h in command.lower() for h in ["help", "info", "--help", "-h"])
        is_question = any(q in command.lower() for q in ["?", "what", "how", "why", "who", "where", "when"])
        
        if is_help or is_question:
            show_skill_info(skill_name, skill_path)
            return

        tool_path = os.path.join(skill_path, "tools", command)
        if not os.path.exists(tool_path):
            if os.path.exists(tool_path + ".sh"):
                tool_path += ".sh"
            elif os.path.exists(tool_path + ".py"):
                tool_path += ".py"
            else:
                skill_dir_name = os.path.basename(skill_path)
                skill_tool_base = os.path.join(skill_path, "tools", skill_dir_name.lower())
                if os.path.exists(skill_tool_base + ".py"):
                    tool_path = skill_tool_base + ".py"
                    cmd_args = [command] + cmd_args 
                elif os.path.exists(skill_tool_base + ".sh"):
                    tool_path = skill_tool_base + ".sh"
                    cmd_args = [command] + cmd_args
                else:
                    tool_path = None
        
        if tool_path:
            try:
                emit_event(skill_name, command, cmd_args)
                if tool_path.endswith(".py"):
                    subprocess.run([sys.executable, tool_path] + cmd_args, check=True)
                else:
                    subprocess.run([tool_path] + cmd_args, check=True)
            except subprocess.CalledProcessError as e:
                PAI_UI.tip(f"It looks like '{command}' might not be the right command for {skill_name}.")
                console.print(f"[dim]Try running 'pai info {skill_name}' to see available commands.[/dim]")
                sys.exit(e.returncode)
        else:
            PAI_UI.error(f"Command '{command}' not found in skill '{skill_name}' tools.")
            PAI_UI.tip(f"Try running 'pai info {skill_name}' to see available commands.")
            sys.exit(1)
    else:
        show_skill_info(skill_name, skill_path)

def emit_event(skill, command, args):
    import time
    from datetime import datetime
    
    pst_now = datetime.now().isoformat()
    event = {
        "source_app": "pai-bridge",
        "session_id": os.environ.get("PAI_SESSION_ID", "bridge-session"),
        "hook_event_type": "PostToolUse",
        "payload": {
            "tool_name": f"{skill}:{command}",
            "tool_input": {"args": args},
            "description": f"Executed PAI skill: {skill} {command}"
        },
        "timestamp": int(time.time() * 1000),
        "timestamp_pst": pst_now
    }
    
    now = datetime.now()
    year_month = now.strftime("%Y-%m")
    year_month_day = now.strftime("%Y-%m-%d")
    log_dir = os.path.join(PAI_ROOT, "History", "raw-outputs", year_month)
    os.makedirs(log_dir, exist_ok=True)
    log_file = os.path.join(log_dir, f"{year_month_day}_all-events.jsonl")
    
    try:
        with open(log_file, "a") as f:
            f.write(json.dumps(event) + "\n")
    except:
        pass

def main():
    if len(sys.argv) < 2:
        show_help()
        sys.exit(0)

    cmd = sys.argv[1]
    if cmd == "list" or cmd == "--list" or cmd == "-l":
        list_skills()
    elif cmd == "info":
        if len(sys.argv) < 3:
            PAI_UI.error("Usage: pai info <skill>")
            sys.exit(1)
        run_skill(sys.argv[2], [])
    elif cmd == "run":
        if len(sys.argv) < 3:
            PAI_UI.error("Usage: pai run <skill> <cmd> [args]")
            sys.exit(1)
        run_skill(sys.argv[2], sys.argv[3:])
    elif cmd == "check":
        subprocess.run([os.path.join(PAI_ROOT, "bin", "pai-check")])
    elif cmd == "init":
        subprocess.run([os.path.join(PAI_ROOT, "bin", "pai-init")])
    elif cmd == "mcp":
        subprocess.run([os.path.join(PAI_ROOT, "bin", "pai-omni")])
    elif cmd == "help" or cmd == "--help" or cmd == "-h":
        show_help()
    else:
        if get_skill_path(cmd):
            run_skill(cmd, sys.argv[2:])
        else:
            PAI_UI.error(f"Unknown command or skill: {cmd}")
            PAI_UI.tip("Try [bold]pai help[/bold] for usage.")
            sys.exit(1)

if __name__ == "__main__":
    main()
