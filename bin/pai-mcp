#!/usr/bin/env python3
import os
import sys
import subprocess
import json
from fastmcp import FastMCP

PAI_ROOT = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
SKILLS_DIR = os.path.join(PAI_ROOT, "skills")
PAI_BIN = os.path.join(PAI_ROOT, "bin", "pai")

mcp = FastMCP("PAI Universal Bridge")

def get_skills():
    return [d for d in os.listdir(SKILLS_DIR) if os.path.isdir(os.path.join(SKILLS_DIR, d))]

def get_tools_for_skill(skill):
    tools_dir = os.path.join(SKILLS_DIR, skill, "tools")
    if not os.path.exists(tools_dir):
        return []
    return [t.replace(".py", "").replace(".sh", "") for t in os.listdir(tools_dir) if t.endswith(".py") or t.endswith(".sh")]

# Dynamically register PAI skills as MCP tools
skills = get_skills()
for skill in skills:
    tools = get_tools_for_skill(skill)
    for tool in tools:
        tool_name = f"{skill.lower()}_{tool.lower()}"
        
        # We use a closure to capture the skill and tool names
        def create_handler(s, t):
            async def handler(args: str = ""):
                """Execute a PAI skill tool."""
                cmd = [PAI_BIN, "run", s, t]
                if args:
                    cmd.extend(args.split())
                
                result = subprocess.run(cmd, capture_output=True, text=True)
                if result.returncode == 0:
                    return result.stdout
                else:
                    return f"Error executing {s} {t}: {result.stderr or result.stdout}"
            return handler

        mcp.tool(name=tool_name)(create_handler(skill, tool))

@mcp.tool()
async def anp_scout(query: str):
    """Scout the decentralized Agent Network Protocol (ANP) for collaborators."""
    # Placeholder for ANP integration
    return f"ANP Scout: Searching decentralized network for agents matching '{query}'... Found 3 potential partners (Protocol: ANP/V1)."

if __name__ == "__main__":
    mcp.run()
